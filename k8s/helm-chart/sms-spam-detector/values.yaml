# Global settings
namespace: sms-spam-detection

# Container registry settings
imageRegistry: ghcr.io
imageOrganization: doda25-team12
imagePullPolicy: Always

# Image pull secrets (for private registries)
imagePullSecrets:
  enabled: false
  name: container-registry-secret

# Model Service configuration
modelService:
  enabled: true
  name: model-service
  versionLabel: v1
  image:
    repository: model-service
    tag: latest
  replicas: 2
  canary:
    enabled: false
    name: model-service-canary
    image:
      repository: model-service
      tag: latest
    replicas: 1
    versionLabel: v2
  shadow:
    enabled: false
    name: model-service-shadow
    image:
      repository: model-service
      tag: latest
    replicas: 1
    versionLabel: v-shadow
    mirrorPercentage: 100
  service:
    type: ClusterIP
    port: 8081
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"
  livenessProbe:
    enabled: true
    path: /apidocs
    initialDelaySeconds: 30
    periodSeconds: 10
  readinessProbe:
    enabled: true
    path: /apidocs
    initialDelaySeconds: 10
    periodSeconds: 5

# App Service configuration
appService:
  enabled: true
  name: app-service
  versionLabel: v1
  image:
    repository: app
    tag: latest
  replicas: 2
  canary:
    enabled: false
    name: app-service-canary
    image:
      repository: app
      tag: latest
    replicas: 1
    versionLabel: v2
  service:
    type: ClusterIP
    port: 8080
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  livenessProbe:
    enabled: true
    path: /sms
    initialDelaySeconds: 45
    periodSeconds: 10
  readinessProbe:
    enabled: true
    path: /sms
    initialDelaySeconds: 30
    periodSeconds: 5

# Persistent storage for ML models
persistence:
  enabled: true
  storageType: hostPath  # Options: hostPath, nfs
  hostPath:
    path: /mnt/shared/models
  accessMode: ReadOnlyMany
  size: 1Gi
  reclaimPolicy: Retain

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  host: sms.local
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/rewrite-target: /
  rateLimit:
    enabled: true
    rpm: 10           # global cap of 10 requests per minute
    burst: 5          # short bursts allowed before throttling
  tls:
    enabled: false
    secretName: ""

# Istio configuration
istio:
  enabled: false
  gateway:
    name: sms-gateway
    host: sms-istio.local
    selectorLabels:
      istio: ingressgateway
  virtualService:
    name: sms-virtualservice
  traffic:
    app:
      stableWeight: 90
      canaryWeight: 10
    sticky:
      enabled: true
      cookieName: experiment
      stableCookieValue: stable
      canaryCookieValue: canary

# ConfigMap data
config:
  appInternalPort: "8080"
  modelInternalPort: "8081"
  modelServiceUrl: "http://model-service:8081"

# Secret placeholders
secrets:
  # Docker registry credentials (base64-encoded .dockerconfigjson)
  # Replace with actual credentials before installation
  # Generate with: kubectl create secret docker-registry temp-secret \
  #   --docker-server=ghcr.io --docker-username=YOUR_USERNAME \
  #   --docker-password=YOUR_PAT --docker-email=YOUR_EMAIL \
  #   --dry-run=client -o yaml | grep '\.dockerconfigjson:' | awk '{print $2}'
  dockerConfigJson: "PLACEHOLDER_REPLACE_WITH_BASE64_DOCKER_CONFIG"

# ========================================
# Monitoring Configuration (Prometheus)
# ========================================
monitoring:
  enabled: false
  
  # ServiceMonitor configuration for app-service
  appService:
    enabled: true
    path: /metrics
    port: http
    interval: 15s
    scrapeTimeout: 10s
    
  # ServiceMonitor configuration for model-service
  modelService:
    enabled: true
    path: /metrics
    port: http
    interval: 15s
    scrapeTimeout: 10s

# ========================================
# Prometheus Stack Configuration
# ========================================
prometheus:
  # Enable the Prometheus Operator
  prometheusOperator:
    enabled: true
    
  # Prometheus server configuration
  prometheus:
    enabled: true
    prometheusSpec:
      # Namespace selector for ServiceMonitors
      serviceMonitorSelectorNilUsesHelmValues: false
      serviceMonitorSelector: {}
      serviceMonitorNamespaceSelector: {}
      # Retention period for metrics
      retention: 10d
      # Resource limits
      resources:
        requests:
          memory: 400Mi
          cpu: 200m
        limits:
          memory: 2Gi
          cpu: 1000m
      # Storage configuration`
      storageSpec:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 10Gi
    ingress:
      enabled: true
      ingressClassName: nginx
      hosts:
        - prometheus.local
      paths:
        - /
      annotations:
        nginx.ingress.kubernetes.io/ssl-redirect: "false"
  
  grafana:
    enabled: true
    adminPassword: "prom-operator"
    persistence:
      enabled: true
      size: 1Gi
    ingress:
      enabled: true
      ingressClassName: nginx
      path: /
      hosts:
        - grafana.local
      annotations:
        nginx.ingress.kubernetes.io/ssl-redirect: "false"
  
  # AlertManager configuration
  alertmanager:
    enabled: true
    alertmanagerSpec:
      resources:
        requests:
          memory: 64Mi
          cpu: 50m
        limits:
          memory: 256Mi
          cpu: 200m
    ingress:
      enabled: true
      ingressClassName: nginx
      hosts:
        - alertmanager.local
      paths:
        - /
      annotations:
        nginx.ingress.kubernetes.io/ssl-redirect: "false"

alertmanagerConfig:
  enabled: false
  name: sms-alertmanager-config
  # Reference the secret where all SMTP info is stored
  smtpSecretName: alertmanager-email-secret
  smtpPasswordKey: authPassword  # key inside the secret for password
  smtpUsernameKey: authUsername  # key inside the secret for username
  smtpSmarthostKey: smarthost     # key inside the secret for smarthost
  smtpFromKey: from               # key inside the secret for 'from' field
  smtpToKey: to                   # key inside the secret for 'to' field

# PrometheusRule for alerting
prometheusRule:
  enabled: false
  name: sms-prometheusrules
  group: high-traffic-alerts
  metricName: http_requests_total
  metricLabelSelector: 'job="app-service"'
  threshold_requests_per_minute: 15
  duration_minutes: 2

  
  # Disable components we don't need
  kubeStateMetrics:
    enabled: true
  nodeExporter:
    enabled: true
  kubeApiServer:
    enabled: false
  kubelet:
    enabled: false
  kubeControllerManager:
    enabled: false
  coreDns:
    enabled: false
  kubeDns:
    enabled: false
  kubeEtcd:
    enabled: false
  kubeScheduler:
    enabled: false
  kubeProxy:
    enabled: false

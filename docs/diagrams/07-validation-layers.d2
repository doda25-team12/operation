# Configuration Validation - 6 Layers
# Render: d2 07-validation-layers.d2 07-validation-layers.svg

title: "6-Layer Validation Pipeline" {
  near: top-center
  shape: text
  style.font-size: 24
  style.bold: true
}

direction: right

# Layer 1
layer1: "Layer 1: JSON Schema\n\nStructural Validation\n- Required fields\n- Data types\n- Port ranges" {
  shape: rectangle
  style.fill: "#1976d2"
  style.font-color: white
  style.stroke: "#0d47a1"
  style.stroke-width: 2
}

# Layer 2
layer2: "Layer 2: Port Consistency\n\nCross-file Alignment\n- .env ↔ values.yaml\n- service.port match" {
  shape: rectangle
  style.fill: "#388e3c"
  style.font-color: white
  style.stroke: "#1b5e20"
  style.stroke-width: 2
}

# Layer 3
layer3: "Layer 3: Image Tags\n\nTag Uniqueness\n- Canary ≠ Stable\n- Shadow ≠ Stable" {
  shape: rectangle
  style.fill: "#f57c00"
  style.font-color: white
  style.stroke: "#e65100"
  style.stroke-width: 2
}

# Layer 4
layer4: "Layer 4: Version Labels\n\nLabel Alignment\n- version: v1 (stable)\n- version: v2 (canary)" {
  shape: rectangle
  style.fill: "#c2185b"
  style.font-color: white
  style.stroke: "#880e4f"
  style.stroke-width: 2
}

# Layer 5
layer5: "Layer 5: ConfigMap\n\nEnv Var Injection\n- MODEL_VERSION\n- MODEL_SERVICE_URL" {
  shape: rectangle
  style.fill: "#512da8"
  style.font-color: white
  style.stroke: "#311b92"
  style.stroke-width: 2
}

# Layer 6
layer6: "Layer 6: Env Variables\n\nUsage Verification\n- .env referenced\n- No orphans" {
  shape: rectangle
  style.fill: "#455a64"
  style.font-color: white
  style.stroke: "#263238"
  style.stroke-width: 2
}

# Result
result: "Result" {
  shape: diamond
  style.fill: "#ffeb3b"
  width: 100
  height: 60
}

pass: "PASS" {
  shape: rectangle
  style.fill: "#4caf50"
  style.font-color: white
}

fail: "FAIL" {
  shape: rectangle
  style.fill: "#f44336"
  style.font-color: white
}

# Connections
layer1 -> layer2 {style.stroke-width: 2}
layer2 -> layer3 {style.stroke-width: 2}
layer3 -> layer4 {style.stroke-width: 2}
layer4 -> layer5 {style.stroke-width: 2}
layer5 -> layer6 {style.stroke-width: 2}
layer6 -> result {style.stroke-width: 2}
result -> pass: "all pass" {style.stroke: "#4caf50"; style.stroke-width: 2}
result -> fail: "any error" {style.stroke: "#f44336"; style.stroke-width: 2}

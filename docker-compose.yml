services:
  # -------------------------------------------------------
  # 1. The Python Model Service (Backend)
  # -------------------------------------------------------
  model-service:
    image: ghcr.io/${ORG_NAME}/model-service:${VERSION}

    environment:
      - PORT=${MODEL_INTERNAL_PORT}
      - MODEL_VERSION=${MODEL_VERSION_ENV:-1.0.2}
      - MODEL_BASE_URL=${MODEL_BASE_URL:-}

    # Inject the model file from host to container
    # We map the local './models' folder to '/models' inside the container
    # Also mount to /app/output for backward compatibility with text_preprocessing.py
    volumes:
      - ./models:/models
      - ./models:/app/output

    # Fix architecture mismatch by reinstalling packages with compiled extensions for current platform
    command: sh -c "pip install --force-reinstall --no-cache-dir rpds-py regex numpy scipy scikit-learn pandas && python src/serve_model.py"

    # restart policy based on grading criteria
    restart: unless-stopped

  # -------------------------------------------------------
  # 2. The Java App Service (Frontend)
  # -------------------------------------------------------
  app-service:
    image: ghcr.io/${ORG_NAME}/app:${APP_VERSION:-${VERSION}}

    ports:
      - "${HOST_PORT}:${APP_INTERNAL_PORT}"

    environment:
      - PORT=${APP_INTERNAL_PORT}
      - MODEL_SERVICE_URL=http://model-service:${MODEL_INTERNAL_PORT}

    depends_on:
      - model-service

    restart: unless-stopped

  # -------------------------------------------------------
  # 3. Prometheus (Metrics Collection)
  # -------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    
    ports:
      - "9090:9090"
    
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    
    restart: unless-stopped

  # -------------------------------------------------------
  # 4. Grafana (Visualization Dashboard)
  # -------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    
    ports:
      - "3000:3000"
    
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    
    volumes:
      - grafana-data:/var/lib/grafana
      - ./k8s/helm-chart/sms-spam-detector/dashboards:/etc/grafana/provisioning/dashboards/dashboards
    
    depends_on:
      - prometheus
    
    restart: unless-stopped

volumes:
  prometheus-data:
  grafana-data: